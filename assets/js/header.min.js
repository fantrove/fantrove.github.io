// header.min.js
// ✅ ปรับปรุง: Immediate overlay injection + startup readiness manager
(function() {
    // --- Immediate overlay injection to avoid flashing page behind while modules load ---
    (function createImmediateOverlayAndStartup() {
        try {
            const OVERLAY_ID = 'instant-loading-overlay';
            const STYLE_ID = 'instant-loading-styles';
            const DEFAULT_ZINDEX = 15000;
            if (!document.getElementById(STYLE_ID)) {
                const style = document.createElement('style');
                style.id = STYLE_ID;
                style.textContent = `
#${OVERLAY_ID} {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,0.96);
  z-index: ${DEFAULT_ZINDEX};
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  contain: strict;
}
#${OVERLAY_ID} .content-loading-spinner { display:flex; flex-direction:column; align-items:center; justify-content:center; }
#${OVERLAY_ID} .spinner-svg { width:56px; height:56px; margin-bottom:12px; }
#${OVERLAY_ID} .loading-message { font-size:1.06rem; color:#2196f3; text-align:center; font-weight:500; }
`;
                document.head.appendChild(style);
            }
            if (!document.getElementById(OVERLAY_ID)) {
                const overlay = document.createElement('div');
                overlay.id = OVERLAY_ID;
                overlay.setAttribute('role', 'status');
                overlay.setAttribute('aria-live', 'polite');
                overlay.style.zIndex = String(DEFAULT_ZINDEX);
                const lang = localStorage.getItem('selectedLang') || 'en';
                const defaultMessage = (lang === 'th') ? 'กำลังโหลดเนื้อหา...' : 'Loading content...';
                overlay.innerHTML = `
  <div class="content-loading-spinner" aria-hidden="true">
    <div class="spinner-svg" aria-hidden="true">
      <svg viewBox="0 0 48 48" focusable="false" aria-hidden="true" role="img">
        <circle cx="24" cy="24" r="20" stroke="#eee" stroke-width="5" fill="none"></circle>
        <circle class="spinner-svg-fg" cx="24" cy="24" r="20" stroke="#4285f4" stroke-width="5" stroke-linecap="round" stroke-dasharray="90 125" style="animation:rotate 1s linear infinite"></circle>
      </svg>
    </div>
    <div class="loading-message">${defaultMessage}</div>
  </div>
`;
                document.body.appendChild(overlay);
                overlay.offsetHeight;
            }

            // small spinner keyframes (in case overlay.js not yet loaded)
            if (!document.getElementById('headerv2-inline-spin-styles')) {
                const ss = document.createElement('style');
                ss.id = 'headerv2-inline-spin-styles';
                ss.textContent = `
@keyframes rotate { from { transform: rotate(0); } to { transform: rotate(360deg); } }
.spinner-svg-fg { animation: rotate 1s linear infinite; stroke: #4285f4; fill:none; }
`;
                document.head.appendChild(ss);
            }
        } catch (err) {
            try { console.error('createImmediateOverlay error', err); } catch {}
        }

        // --- Minimal startup readiness manager (global) ---
        try {
            if (!window._headerV2_startupManager) {
                window._headerV2_startupManager = (function() {
                    const required = new Set([
                        'styles',
                        'fonts',
                        'dataManager',
                        'buttonManager',
                        'managers',
                        'navigation',
                        'contentRender',
                        'perf'
                    ]);
                    const ready = new Set();
                    const failed = new Set();
                    let resolveAll, rejectAll;
                    let settled = false;
                    let readyPromise = new Promise((res, rej) => { resolveAll = res; rejectAll = rej; });

                    function checkAndResolve() {
                        if (settled) return;
                        const allOk = [...required].every(r => ready.has(r));
                        if (allOk) {
                            settled = true;
                            try { resolveAll({ ok: true, ready: [...ready] }); } catch {}
                        }
                    }

                    function markReady(name) {
                        try {
                            if (!name) return;
                            ready.add(String(name));
                            checkAndResolve();
                        } catch {}
                    }
                    function markFailed(name) {
                        try {
                            if (!name) return;
                            failed.add(String(name));
                        } catch {}
                    }
                    function addRequired(name) {
                        try { if (name) required.add(String(name)); } catch {}
                    }
                    function setRequired(list) {
                        try { if (Array.isArray(list)) { required.clear(); list.forEach(i => required.add(String(i))); } } catch {}
                    }

                    async function waitForAll(timeoutMs = 30000) {
                        try {
                            if (settled) return { ok: true, ready: [...ready] };
                            const race = await Promise.race([
                                readyPromise,
                                new Promise(res => setTimeout(() => res({ ok: false, timeout: true, ready: [...ready], failed: [...failed] }), timeoutMs))
                            ]);
                            return race;
                        } catch (e) {
                            return { ok: false, error: e, ready: [...ready], failed: [...failed] };
                        }
                    }

                    return {
                        required,
                        ready,
                        failed,
                        markReady,
                        markFailed,
                        addRequired,
                        setRequired,
                        waitForAll,
                        readyPromise,
                        // runtime flags
                        blockIndividualLoaders: true,
                        isInitialOverlayActive: !!document.getElementById('instant-loading-overlay')
                    };
                })();
            }
            try { window._headerV2_startupManager.markReady('overlayInjected'); } catch {}
        } catch (e) {
            try { console.error('startup manager init error', e); } catch {}
        }
    })();
    // --- End immediate overlay + startup manager ---

    const MODULE_BASE = './header-modules/';
    
    const MODULES = [
        'overlay.js',
        'utils.js',
        'dataManager.js',
        'contentLoadingManager.js',
        'contentManager.js',
        'managers.js',
        'unifiedCopyToClipboard.js',
        'init.js'
    ];
    
    async function loadAll() {
        try {
            // Parallel module loading
            const imports = MODULES.map(m => import(MODULE_BASE + m));
            const mods = await Promise.all(imports);
            
            // Find and execute init
            const init = mods.find(m => m && m.init) || mods[mods.length - 1];
            if (init && typeof init.init === 'function') {
                await init.init();
            } else if (typeof window.headerV2_initializeApp === 'function') {
                await window.headerV2_initializeApp();
            }
        } catch (err) {
            console.error('header.min.js bootstrap error', err);
            try {
                if (window._headerV2_utils && window._headerV2_utils.showNotification) {
                    window._headerV2_utils.showNotification('โหลด header modules ไม่สำเร็จ', 'error');
                }
            } catch {}
        } finally {
            // DO NOT remove overlay here. init.js will call startupManager.waitForAll(...) then remove overlay.
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAll);
    } else {
        loadAll();
    }
})();